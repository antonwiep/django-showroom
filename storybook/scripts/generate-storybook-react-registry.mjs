import fs from "node:fs";
import path from "node:path";

const ROOT_DIR = process.cwd();
const COMPONENTS_ROOT = path.join(ROOT_DIR, "components", "cotton", "ds");
const OUTPUT_FILE = path.join(
  ROOT_DIR,
  "storybook",
  "storybookReact.registry.generated.js"
);

function walkComponentJsonFiles(directory) {
  const entries = fs.readdirSync(directory, { withFileTypes: true });
  const files = [];

  for (const entry of entries) {
    const fullPath = path.join(directory, entry.name);
    if (entry.isDirectory()) {
      files.push(...walkComponentJsonFiles(fullPath));
      continue;
    }

    if (entry.isFile() && entry.name === "component.json") {
      files.push(fullPath);
    }
  }

  return files;
}

function normalizeImportPath(fromFile, toFile) {
  let importPath = path.relative(path.dirname(fromFile), toFile).replaceAll("\\", "/");
  if (!importPath.startsWith(".")) {
    importPath = `./${importPath}`;
  }
  return importPath;
}

function readJson(filePath) {
  const content = fs.readFileSync(filePath, "utf8");
  return JSON.parse(content);
}

function getReactPreviewEntries() {
  const metadataFiles = walkComponentJsonFiles(COMPONENTS_ROOT).sort();
  const entries = [];

  for (const metadataPath of metadataFiles) {
    const metadata = readJson(metadataPath);
    const componentDir = path.dirname(metadataPath);
    const slug = metadata.slug;
    const reactConfig = metadata.react;

    if (!slug || !reactConfig || typeof reactConfig !== "object") {
      continue;
    }

    const previewPath = reactConfig.preview;
    if (typeof previewPath !== "string" || !previewPath.trim()) {
      continue;
    }

    const absolutePreviewPath = path.join(componentDir, previewPath);
    if (!fs.existsSync(absolutePreviewPath)) {
      throw new Error(
        `React preview file not found for component '${slug}': ${absolutePreviewPath}`
      );
    }

    entries.push({
      slug,
      importPath: normalizeImportPath(OUTPUT_FILE, absolutePreviewPath),
    });
  }

  return entries;
}

function writeRegistryFile(entries) {
  const lines = [];

  lines.push("// Auto-generated by storybook/scripts/generate-storybook-react-registry.mjs");
  lines.push("// Do not edit manually. Update component.json react.preview entries instead.");
  lines.push("");

  if (!entries.length) {
    lines.push("export const storybookReactRegistry = {};\n");
    fs.writeFileSync(OUTPUT_FILE, lines.join("\n"), "utf8");
    return;
  }

  entries.forEach((entry, index) => {
    lines.push(
      `import { stories as stories${index} } from \"${entry.importPath}\";`
    );
  });

  lines.push("");
  lines.push("export const storybookReactRegistry = {");
  entries.forEach((entry, index) => {
    lines.push(`  \"${entry.slug}\": stories${index},`);
  });
  lines.push("};");
  lines.push("");

  fs.writeFileSync(OUTPUT_FILE, lines.join("\n"), "utf8");
}

function main() {
  const entries = getReactPreviewEntries();
  writeRegistryFile(entries);
  console.log(`Generated React story registry for ${entries.length} component(s).`);
}

main();

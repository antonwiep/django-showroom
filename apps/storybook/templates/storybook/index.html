{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Django Storybook</title>
    <link href="{% static 'favicon.ico' %}" rel="shortcut icon" type="image/x-icon">
    <link href="{% static 'css/output.css' %}" rel="stylesheet">
    <style>
        [x-cloak] {
            display: none !important;
        }

        details > summary {
            list-style: none;
        }

        details > summary::-webkit-details-marker {
            display: none;
        }
    </style>
</head>
<body class="h-screen overflow-hidden bg-g12 text-g2" data-storybook="true">
    <div
        x-cloak
        x-data="storybookPage('{{ active_component.slug }}', '{% if active_story %}{{ active_story.slug }}{% endif %}', '{{ active_component.type }}', {{ has_react_preview|yesno:'true,false' }})"
        class="flex h-screen"
    >
        <!-- Sidebar navigation -->
        <aside class="flex h-full w-72 shrink-0 flex-col border-r border-g11 bg-g12">
            <div class="flex h-14 items-center justify-between border-b border-alpha-12 px-4">
                <div class="flex items-center gap-2">
                    <span class="inline-flex size-5 items-center justify-center rounded-4 bg-a9 text-g0 text-mini-medium">S</span>
                    <span class="text-regular-medium text-g1">Django Storybook</span>
                </div>
            </div>

            <nav class="min-h-0 flex-1 overflow-y-auto p-2">
                {% for component in components %}
                    {% if component.type == "page" %}
                        <a
                            href="{% url 'storybook:component' component=component.slug %}"
                            class="mb-0.5 flex items-center gap-2 rounded-6 border border-transparent px-2 py-1.5 transition-colors {% if active_component.slug == component.slug %}text-regular-medium bg-g11 text-g1{% else %}text-regular text-g5 hover:bg-g11 hover:text-g2{% endif %}"
                        >
                            <span class="inline-flex size-4 items-center justify-center text-[#f2b600]">
                                <svg aria-hidden="true" class="size-3.5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" viewBox="0 0 24 24">
                                    <path d="M8.5 4.5h8.5v15H6.5v-13Z"></path>
                                    <path d="M8.5 4.5v2H6.5"></path>
                                </svg>
                            </span>
                            <span>{{ component.label }}</span>
                        </a>
                    {% else %}
                        <details class="group mb-0.5 rounded-6" {% if component.slug == active_component.slug %}open{% endif %}>
                            <summary class="flex cursor-pointer items-center gap-1.5 rounded-6 border border-transparent px-2 py-1.5 text-regular text-g4 transition-colors hover:bg-g11 hover:text-g2">
                                <span class="inline-flex size-3.5 items-center justify-center text-g7 transition-transform group-open:rotate-90">
                                    <svg aria-hidden="true" class="size-3" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" viewBox="0 0 24 24">
                                        <path d="m10 7 5 5-5 5"></path>
                                    </svg>
                                </span>
                                <span class="inline-flex size-4 items-center justify-center text-a8">
                                    <svg aria-hidden="true" class="size-3.5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" viewBox="0 0 24 24">
                                        <rect height="6" rx="1" width="6" x="4" y="4"></rect>
                                        <rect height="6" rx="1" width="6" x="14" y="4"></rect>
                                        <rect height="6" rx="1" width="6" x="4" y="14"></rect>
                                        <rect height="6" rx="1" width="6" x="14" y="14"></rect>
                                    </svg>
                                </span>
                                <span>{{ component.label }}</span>
                            </summary>

                            <div class="mt-0.5 flex flex-col gap-0.5 pl-8">
                                {% if component.stories %}
                                    {% for story in component.stories %}
                                        <a
                                            href="{% url 'storybook:story' component=component.slug story=story.slug %}"
                                            class="flex items-center gap-2 rounded-6 px-2 py-1 transition-colors {% if active_component.slug == component.slug and active_story and active_story.slug == story.slug %} text-regular-medium bg-a9 text-g0{% else %} text-regular text-g6 hover:bg-g11 hover:text-g3{% endif %}"
                                        >
                                            <span class="inline-flex size-3.5 items-center justify-center">
                                                <svg aria-hidden="true" class="size-3 text-a8" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" viewBox="0 0 24 24">
                                                    <path d="M7 4.5h10v15l-5-3-5 3z"></path>
                                                </svg>
                                            </span>
                                            <span>{{ story.name }}</span>
                                        </a>
                                    {% endfor %}
                                {% else %}
                                    <span class="rounded-6 px-2 py-1 text-mini text-g8">Coming soon</span>
                                {% endif %}
                            </div>
                        </details>
                    {% endif %}
                {% endfor %}
            </nav>
        </aside>

        <!-- Main work area -->
        <main class="flex min-w-0 flex-1 flex-col bg-g12">
            <!-- Story header and zoom controls -->
            <header class="flex h-11 shrink-0 items-center justify-between border-b border-alpha-12 bg-12 px-4">
                <div class="flex items-center gap-2">
                    <span class="text-sm-medium text-g2">{{ active_component.label }}</span>
                    {% if active_story %}
                        <span class="text-g8">/</span>
                        <span class="text-sm-medium text-g5">{{ active_story.name }}</span>
                    {% endif %}
                </div>

                <div class="flex items-center gap-2">
                    <div x-cloak x-show="canUseReactPreview" class="inline-flex items-center rounded-6 bg-g11 p-0.5">
                        <button
                            @click="setPreviewMode('django')"
                            :class="effectivePreviewMode === 'django' ? 'bg-a9 text-g0' : 'text-g4 hover:text-g2'"
                            class="inline-flex h-6 items-center justify-center rounded-4 px-2 text-mini-medium transition-colors cursor-pointer"
                            type="button"
                        >Cotton</button>
                        <button
                            @click="setPreviewMode('react')"
                            :class="effectivePreviewMode === 'react' ? 'bg-a9 text-g0' : 'text-g4 hover:text-g2'"
                            class="inline-flex h-6 items-center justify-center rounded-4 px-2 text-mini-medium transition-colors cursor-pointer"
                            type="button"
                        >React</button>
                        <button
                            @click="setPreviewMode('split')"
                            :class="effectivePreviewMode === 'split' ? 'bg-a9 text-g0' : 'text-g4 hover:text-g2'"
                            class="inline-flex h-6 items-center justify-center rounded-4 px-2 text-mini-medium transition-colors cursor-pointer"
                            type="button"
                        >Split</button>
                    </div>
                    <button
                        @click="toggleControls"
                        :disabled="!hasControls"
                        :class="hasControls ? (showControls ? 'bg-g11 text-g2 hover:bg-g10' : 'text-g4 hover:bg-g11 hover:text-g2') : 'cursor-not-allowed text-g8 opacity-60'"
                        class="inline-flex h-7 items-center justify-center rounded-6 px-2 text-mini-medium transition-colors cursor-pointer"
                        type="button"
                        x-text="showControls ? 'Hide Controls' : 'Show Controls'"
                    ></button>
                    <button
                        @click="zoomOut"
                        :disabled="!isZoomEnabled"
                        :class="isZoomEnabled ? 'text-g4 hover:bg-g11 hover:text-g2 cursor-pointer' : 'cursor-not-allowed text-g8 opacity-60'"
                        class="inline-flex h-7 w-7 items-center justify-center rounded-6"
                        type="button"
                    >
                        -
                    </button>
                    <button
                        @click="resetZoom"
                        :disabled="!isZoomEnabled"
                        :class="isZoomEnabled ? 'text-g3 hover:bg-g11' : 'cursor-not-allowed text-g8 opacity-60'"
                        class="inline-flex h-7 min-w-16 items-center justify-center rounded-6 px-2 text-mini-medium"
                        type="button"
                        x-text="zoomLabel"
                    ></button>
                    <button
                        @click="zoomIn"
                        :disabled="!isZoomEnabled"
                        :class="isZoomEnabled ? 'text-g4 hover:bg-g11 hover:text-g2 cursor-pointer' : 'cursor-not-allowed text-g8 opacity-60'"
                        class="inline-flex h-7 w-7 items-center justify-center rounded-6"
                        type="button"
                    >
                        +
                    </button>
                </div>
            </header>

            <!-- Light preview canvas -->
            <section
                class="min-h-0 flex-1 overflow-hidden bg-p1"
                :class="showControlsPanel ? 'border-b border-alpha-12' : ''"
            >
                <div class="hidden" x-effect="syncReactPreviewState(JSON.stringify(args), effectivePreviewMode, activeComponentSlug, activeStorySlug)"></div>
                <div class="h-full w-full" :class="effectivePreviewMode === 'split' ? 'overflow-hidden' : 'overflow-auto'">
                    <div :class="effectivePreviewMode === 'split' ? 'h-full w-full' : 'flex min-h-full min-w-full items-center justify-center p-10'">
                        <div data-storybook-zoom-root class="origin-center" :class="effectivePreviewMode === 'split' ? 'h-full w-full' : ''" :style="effectivePreviewMode === 'split' ? '' : zoomStyle">
                            <div x-ref="previewRoot" data-storybook-preview-root :class="effectivePreviewMode === 'split' ? 'h-full w-full' : ''">
                                {% if active_template %}
                                    <template x-if="effectivePreviewMode === 'django'">
                                        <div class="min-w-[420px]">
                                            {% include active_template %}
                                        </div>
                                    </template>

                                    <template x-if="effectivePreviewMode === 'react'">
                                        <div class="flex min-h-52 min-w-[420px] items-center justify-center">
                                            <div class="flex w-fit max-w-full items-center justify-center" data-react-story-root></div>
                                        </div>
                                    </template>

                                    <template x-if="effectivePreviewMode === 'split'">
                                        <div class="grid h-full min-h-full w-full grid-cols-2">
                                            <div class="flex min-h-0 min-w-0 flex-col">
                                                <div class="flex h-10 shrink-0 items-center justify-center border-alpha-12 border-b text-mini-medium text-g9">Django</div>
                                                <div class="relative min-h-0 flex-1 overflow-auto" data-storybook-preview-pane>
                                                    <div class="flex min-h-full min-w-full items-center justify-center p-8">
                                                        <div data-storybook-zoom-root class="origin-center" :style="splitZoomStyle">
                                                            <div class="min-w-[320px] max-w-full">
                                                                {% include active_template %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex min-h-0 min-w-0 flex-col border-alpha-12 border-l">
                                                <div class="flex h-10 shrink-0 items-center justify-center border-alpha-12 border-b text-mini-medium text-g9">React</div>
                                                <div class="relative min-h-0 flex-1 overflow-auto" data-storybook-preview-pane>
                                                    <div class="flex min-h-full min-w-full items-center justify-center p-8">
                                                        <div data-storybook-zoom-root class="origin-center" :style="splitZoomStyle">
                                                            <div class="flex w-fit max-w-full items-center justify-center" data-react-story-root></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                {% else %}
                                    <div class="flex min-h-52 min-w-[420px] items-center justify-center rounded-10 border border-dashed border-g6 bg-g0 px-4 text-regular text-g9">
                                        Story preview coming soon for {{ active_component.label }}.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Generic controls panel -->
            <section x-cloak x-show="showControlsPanel" class="h-[300px] shrink-0 bg-g12">
                <div class="h-full overflow-auto">
                    {% if show_controls %}
                        <table class="w-full border-collapse">
                            <thead class="border-b border-g11">
                                <tr>
                                    <th class="w-0 px-4 py-2 text-left text-mini-medium text-g7">Name</th>
                                    <th class="px-4 py-2 text-left text-mini-medium text-g7">Control</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for control in story_controls %}
                                    <tr class="border-b border-g11 last:border-b-0">
                                        <td class="whitespace-nowrap align-top px-4 py-2.5 text-mini-medium text-g4">{{ control.label }}</td>
                                        <td class="px-4 py-2.5">
                                            {% if control.type == "boolean" %}
                                                <label class="inline-flex items-center gap-2">
                                                    <input type="checkbox" x-model="args.{{ control.name }}">
                                                </label>
                                            {% elif control.type == "textarea" %}
                                                <textarea
                                                    class="w-full rounded-6 border border-g11 bg-g11 px-2 py-1.5 text-mini-medium text-g2 outline-none focus:border-a8"
                                                    rows="{{ control.rows|default:3 }}"
                                                    x-model="args.{{ control.name }}"
                                                ></textarea>
                                            {% elif control.type == "text" %}
                                                <input
                                                    class="w-full rounded-6 border border-g11 bg-g11 px-2 py-1.5 text-mini-medium text-g2 outline-none focus:border-a8"
                                                    type="text"
                                                    x-model="args.{{ control.name }}"
                                                >
                                            {% elif control.type == "number" %}
                                                <input
                                                    class="w-full rounded-6 border border-g11 bg-g11 px-2 py-1.5 text-mini-medium text-g2 outline-none focus:border-a8"
                                                    type="number"
                                                    {% if control.min is not None %}min="{{ control.min }}"{% endif %}
                                                    {% if control.max is not None %}max="{{ control.max }}"{% endif %}
                                                    {% if control.step is not None %}step="{{ control.step }}"{% endif %}
                                                    x-model.number="args.{{ control.name }}"
                                                >
                                            {% elif control.type == "select" %}
                                                <select
                                                    class="w-full rounded-6 border border-g11 bg-g11 px-2 py-1.5 text-mini-medium text-g2 outline-none focus:border-a8"
                                                    x-model="args.{{ control.name }}"
                                                >
                                                    {% for option in control.options %}
                                                        <option value="{{ option.value }}">{{ option.label }}</option>
                                                    {% endfor %}
                                                </select>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <div class="px-4 py-3 text-regular text-g7">
                            This page has no controls yet.
                        </div>
                    {% endif %}
                </div>
            </section>
        </main>
    </div>

    {{ story_defaults|json_script:"storybook-story-defaults" }}
    <script src="{% static 'js/storybookReact.bundle.js' %}"></script>

    <script>
        function storybookPage(activeComponentSlug, activeStorySlug, activeComponentType, hasReactPreview) {
            const defaultsNode = document.getElementById('storybook-story-defaults');
            const defaults = defaultsNode ? JSON.parse(defaultsNode.textContent || '{}') : {};
            const zoomSteps = [25, 50, 75, 90, 100, 110, 125, 150, 200, 300, 400, 800];
            const previewModes = ['django', 'react', 'split'];
            const zoomDisabledComponentSlugs = [];

            return {
                activeComponentSlug,
                activeStorySlug,
                activeComponentType,
                hasReactPreview,
                isZoomEnabled:
                    activeComponentType !== 'page' &&
                    !zoomDisabledComponentSlugs.includes(activeComponentSlug),
                hasControls: {{ show_controls|yesno:"true,false" }},
                zoom: Alpine.$persist(100).as('storybook-zoom'),
                showControls: Alpine.$persist(true).as('storybook-show-controls'),
                previewMode: Alpine.$persist('django').as('storybook-preview-mode'),
                zoomSteps,
                args: defaults,
                get canUseReactPreview() {
                    return this.hasReactPreview && this.activeComponentType !== 'page' && Boolean(this.activeStorySlug);
                },
                get effectivePreviewMode() {
                    if (!this.canUseReactPreview) {
                        return 'django';
                    }
                    return previewModes.includes(this.previewMode) ? this.previewMode : 'django';
                },
                get showControlsPanel() {
                    return this.hasControls && this.showControls;
                },
                get zoomLabel() {
                    return `${this.isZoomEnabled ? this.zoom : 100}%`;
                },
                get zoomStyle() {
                    const effectiveZoom = this.isZoomEnabled ? this.zoom : 100;
                    return `transform: scale(${effectiveZoom / 100}); transform-origin: center center;`;
                },
                get splitZoomStyle() {
                    const effectiveZoom = this.isZoomEnabled ? this.zoom : 100;
                    return `transform: scale(${effectiveZoom / 100}); transform-origin: center center;`;
                },
                setPreviewMode(mode) {
                    if (!this.canUseReactPreview) {
                        this.previewMode = 'django';
                        return;
                    }
                    this.previewMode = previewModes.includes(mode) ? mode : 'django';
                },
                applyArgPatch(nextArgs) {
                    if (!nextArgs || typeof nextArgs !== 'object') {
                        return;
                    }
                    this.args = { ...this.args, ...nextArgs };
                },
                syncReactPreviewState() {
                    const previewApi = window.storybookReactPreview;
                    if (!previewApi || typeof previewApi.sync !== 'function') {
                        return;
                    }

                    this.$nextTick(() => {
                        previewApi.sync({
                            componentSlug: this.activeComponentSlug,
                            storySlug: this.activeStorySlug,
                            mode: this.effectivePreviewMode,
                            args: JSON.parse(JSON.stringify(this.args || {})),
                            onArgsChange: (nextArgs) => this.applyArgPatch(nextArgs),
                        });
                    });
                },
                toggleControls() {
                    if (!this.hasControls) {
                        return;
                    }
                    this.showControls = !this.showControls;
                },
                zoomIn() {
                    if (!this.isZoomEnabled) {
                        return;
                    }
                    const next = this.zoomSteps.find((value) => value > this.zoom);
                    this.zoom = next ?? this.zoomSteps[this.zoomSteps.length - 1];
                },
                zoomOut() {
                    if (!this.isZoomEnabled) {
                        return;
                    }
                    const previous = [...this.zoomSteps].reverse().find((value) => value < this.zoom);
                    this.zoom = previous ?? this.zoomSteps[0];
                },
                resetZoom() {
                    if (!this.isZoomEnabled) {
                        return;
                    }
                    this.zoom = 100;
                },
            };
        }
    </script>

    {% include "includes/scripts.html" %}
</body>
</html>

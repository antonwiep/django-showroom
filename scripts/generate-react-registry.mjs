import fs from "node:fs";
import path from "node:path";
import process from "node:process";

const ROOT = process.cwd();
const COMPONENTS_ROOT = path.join(ROOT, "design-system", "cotton", "ds");
const OUTPUT_FILE = path.join(ROOT, "static", "storybook", "storybookReact.registry.generated.js");

function walk(dir) {
  const entries = fs.readdirSync(dir, { withFileTypes: true });
  const results = [];

  for (const entry of entries) {
    const full = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      results.push(...walk(full));
      continue;
    }

    if (entry.isFile() && entry.name === "component.json") {
      results.push(full);
    }
  }

  return results;
}

function readJson(filePath) {
  return JSON.parse(fs.readFileSync(filePath, "utf8"));
}

function normalizeImport(fromFile, toFile) {
  let rel = path.relative(path.dirname(fromFile), toFile).replaceAll("\\", "/");
  if (!rel.startsWith(".")) {
    rel = `./${rel}`;
  }
  return rel;
}

function main() {
  const files = walk(COMPONENTS_ROOT).sort();
  const entries = [];

  for (const file of files) {
    const component = readJson(file);
    const slug = component?.slug;
    const preview = component?.react?.preview;

    if (!slug || typeof preview !== "string" || !preview.trim()) {
      continue;
    }

    const previewPath = path.join(path.dirname(file), preview);
    if (!fs.existsSync(previewPath)) {
      throw new Error(`Preview not found for '${slug}': ${previewPath}`);
    }

    entries.push({
      slug,
      importPath: normalizeImport(OUTPUT_FILE, previewPath)
    });
  }

  const lines = [];
  lines.push("// Auto-generated by scripts/generate-react-registry.mjs");
  lines.push("// Do not edit manually.");
  lines.push("");

  entries.forEach((entry, index) => {
    lines.push(`import { stories as stories${index} } from \"${entry.importPath}\";`);
  });

  lines.push("");
  lines.push("export const storybookReactRegistry = {");

  entries.forEach((entry, index) => {
    lines.push(`  \"${entry.slug}\": stories${index},`);
  });

  lines.push("};");
  lines.push("");

  fs.mkdirSync(path.dirname(OUTPUT_FILE), { recursive: true });
  fs.writeFileSync(OUTPUT_FILE, lines.join("\n"), "utf8");
  console.log(`Generated registry for ${entries.length} component(s).`);
}

main();
